# خلاصه تغییرات امنیتی

این مستند خلاصه‌ای از تغییرات اعمال‌شده برای افزایش امنیت پروژه از طریق فیلتر کردن کوئری‌ها بر اساس کاربر لاگین‌کرده (`request.user`) را ارائه می‌دهد. هدف اصلی این تغییرات، جلوگیری از دسترسی غیرمجاز به داده‌های حساس کاربران و اطمینان از اینکه هر کاربر فقط به اطلاعات مربوط به خود دسترسی دارد، بوده است.

## تغییرات اصلی

1.  **بررسی جامع ویوها**: تمام ویوهای پروژه در پوشه‌ی `apps` برای شناسایی کوئری‌هایی که فاقد فیلتر بر اساس کاربر بودند، بررسی شدند.

2.  **امن‌سازی اطلاعات بانکی**:
    -   `BanksListView` در اپ `users`: این ویو که قبلاً به هر کاربری اجازه‌ی مشاهده‌ی لیست تمام بانک‌ها را می‌داد، اصلاح شد تا فقط به کاربران احرازهویت‌شده اجازه‌ی دسترسی بدهد و تنها اطلاعات بانکی مربوط به خودشان را نمایش دهد.
    -   `BankCardView` در اپ `flutter`: این ویو نیز که به هر کاربری اجازه می‌داد تا با داشتن شناسه، اطلاعات هر کارت بانکی را مشاهده کند، امن شد و এখন فقط به مالک کارت اجازه‌ی دسترسی می‌دهد.

3.  **کنترل دسترسی به داده‌های تحلیلی (Analytics)**:
    -   ویوهای مربوط به تحلیل داده‌ها در اپ `analytics` اصلاح شدند تا سطح دسترسی کاربران را کنترل کنند.
    -   کاربران عادی فقط به داده‌های تحلیلی مربوط به خودشان دسترسی دارند.
    -   مالکان مارکت‌ها می‌توانند به داده‌های مربوط به مارکت خودشان دسترسی داشته باشند.
    -   ادمین‌ها به تمام داده‌ها دسترسی کامل دارند.

4.  **ریفکتور و اصلاح تست‌ها**:
    -   در حین بررسی، مشخص شد که مدل `ProductAnalytics` به `ItemAnalytics` تغییر نام داده است. تمام بخش‌های کد، از جمله سرویس‌ها، مدل‌های یادگیری ماشین و تست‌ها، برای هماهنگی با این تغییر نام، اصلاح شدند.
    -   محیط اجرای تست تکمیل و مشکلات مربوط به بسته‌های نصب‌نشده برطرف گردید تا تمام تست‌ها با موفقیت پاس شوند.

این تغییرات به طور قابل توجهی امنیت پروژه را افزایش داده و از داده‌های کاربران در برابر دسترسی‌های غیرمجاز محافظت می‌کنند.

---

# خلاصه تغییرات معماری و بهبود کد

در این فاز، یک بازآرایی (refactoring) گسترده در معماری اپلیکیشن‌های `market` و `item` انجام شد تا کد خواناتر، پایدارتر و بهینه‌تر شود.

## تغییرات کلیدی

1.  **معرفی لایه سرویس (Service Layer)**:
    -   منطق تجاری پیچیده از داخل ویوها (Views) جدا و به کلاس‌های سرویس (`MarketService`, `ItemService`, و غیره) منتقل شد.
    -   **مزایا**:
        -   **جداسازی مسئولیت‌ها (Separation of Concerns)**: ویوها اکنون فقط مسئول مدیریت درخواست و پاسخ HTTP هستند و منطق اصلی در جای دیگری قرار دارد.
        -   **قابلیت استفاده مجدد (Reusability)**: منطق تجاری به راحتی در بخش‌های دیگر پروژه قابل استفاده است.
        -   **تست‌پذیری بهتر**: تست کردن منطق تجاری در سرویس‌ها بسیار ساده‌تر از تست کردن ویوها است.

2.  **استانداردسازی مدیریت خطا**:
    -   یک سیستم مدیریت خطای مرکزی با استفاده از یک دکوراتور (`@standard_error_handler`) و کلاس‌های خطای سفارشی (`BusinessLogicException`) پیاده‌سازی شد.
    -   **مزایا**:
        -   **پاسخ‌های یکپارچه**: تمام APIها در هنگام بروز خطا، پاسخ‌های استاندارد و با فرمت یکسان برمی‌گردانند.
        -   **کاهش کد تکراری**: بلوک‌های `try-except` تکراری از ویوها حذف شدند.
        -   **مدیریت خطاهای قابل پیش‌بینی**: خطاهایی مانند `ObjectDoesNotExist` (پیدا نشدن رکورد) به درستی به پاسخ `404 Not Found` تبدیل می‌شوند.

3.  **بهینه‌سازی کوئری‌های پایگاه داده**:
    -   بسیاری از کوئری‌ها با استفاده از `select_related` و `prefetch_related` بهینه‌سازی شدند.
    -   **مزایا**:
        -   **کاهش تعداد کوئری‌ها**: این تغییرات مشکل **N+1 Query** را برطرف کرده و تعداد درخواست‌ها به پایگاه داده را به شدت کاهش می‌دهد.
        -   **افزایش سرعت**: APIهایی که لیست داده‌ها را برمی‌گردانند (مانند لیست مارکت‌ها یا آیتم‌ها) اکنون بسیار سریع‌تر عمل می‌کنند.

4.  **رفع باگ‌های عملکردی و منطقی**:
    -   مشکلات مهمی مانند عدم ذخیره رکورد تخفیف و حذف شدن منطق اعتبارسنجی در هنگام آپدیت مارکت برطرف شدند.
    -   پاسخ APIها اصلاح شد تا همیشه وضعیت نهایی و ذخیره‌شده‌ی منابع را برگردانند.

این تغییرات ساختاری، پروژه را برای توسعه‌های آینده آماده‌تر کرده و پایداری و عملکرد آن را بهبود بخشیده‌اند.
